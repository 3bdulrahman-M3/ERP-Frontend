<app-layout pageTitle="Dashboard">
<div *ngIf="currentRoute === '/dashboard'" class="p-4">
  <div class="space-y-4">
    <!-- Welcome Header -->
    <div class="relative overflow-hidden bg-gradient-to-r from-gray-800 via-gray-700 to-gray-800 rounded-2xl shadow-xl p-6 text-white border border-gray-600">
      <div class="relative z-10">
        <div class="flex items-center justify-between flex-wrap gap-4">
          <div>
            <h1 class="text-3xl font-bold mb-2">Welcome {{ currentUser?.name }} üëã</h1>
            <p class="text-white/90 text-sm">
              {{ currentUser?.role === 'admin' ? 'Admin Dashboard' : 'Student Dashboard' }}
            </p>
          </div>
          <div class="flex items-center gap-3">
            <div class="bg-white/10 backdrop-blur-sm rounded-xl px-4 py-2 border border-white/20">
              <span class="text-lg font-bold text-white">
                {{ currentUser?.role === 'admin' ? 'üëë' : 'üéì' }}
              </span>
              <span class="ml-2 font-semibold">{{ currentUser?.role === 'admin' ? 'Admin' : 'Student' }}</span>
            </div>
          </div>
        </div>
      </div>
      <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
      <div class="absolute bottom-0 left-0 w-24 h-24 bg-white/10 rounded-full blur-2xl"></div>
    </div>
    
    <!-- User Info - Compact -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
      <div class="bg-white rounded-xl shadow-md p-4 border border-gray-100">
        <p class="text-xs text-gray-500 mb-1">Name</p>
        <p class="text-base font-semibold text-gray-800">{{ currentUser?.name }}</p>
      </div>
      <div class="bg-white rounded-xl shadow-md p-4 border border-gray-100">
        <p class="text-xs text-gray-500 mb-1">Email</p>
        <p class="text-sm font-semibold text-gray-800 truncate">{{ currentUser?.email }}</p>
      </div>
    </div>

    <!-- Quick Stats - Admin Only -->
    <div *ngIf="currentUser?.role === 'admin'" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
      <!-- Total Students -->
      <div class="bg-white rounded-xl shadow-md p-4 border-l-4 border-gray-700 hover:shadow-lg transition-shadow">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs text-gray-500 mb-1">Total Students</p>
            <p class="text-2xl font-bold text-gray-800">
              <span *ngIf="!isLoadingStats">{{ totalStudents }}</span>
              <span *ngIf="isLoadingStats" class="inline-block w-6 h-6 border-2 border-gray-700 border-t-transparent rounded-full animate-spin"></span>
            </p>
          </div>
          <div class="text-3xl">üéì</div>
        </div>
      </div>

      <!-- Total Rooms -->
      <div class="bg-white rounded-xl shadow-md p-4 border-l-4 border-gray-600 hover:shadow-lg transition-shadow">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs text-gray-500 mb-1">Total Rooms</p>
            <p class="text-2xl font-bold text-gray-800">
              <span *ngIf="!isLoadingStats">{{ totalRooms }}</span>
              <span *ngIf="isLoadingStats" class="inline-block w-6 h-6 border-2 border-gray-600 border-t-transparent rounded-full animate-spin"></span>
            </p>
          </div>
          <div class="text-3xl">üè†</div>
        </div>
      </div>

      <!-- Available Rooms -->
      <div class="bg-white rounded-xl shadow-md p-4 border-l-4 border-gray-500 hover:shadow-lg transition-shadow">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs text-gray-500 mb-1">Available Rooms</p>
            <p class="text-2xl font-bold text-gray-800">
              <span *ngIf="!isLoadingStats">{{ availableRooms }}</span>
              <span *ngIf="isLoadingStats" class="inline-block w-6 h-6 border-2 border-green-500 border-t-transparent rounded-full animate-spin"></span>
            </p>
          </div>
          <div class="text-3xl">‚úÖ</div>
        </div>
      </div>

      <!-- Occupied Rooms -->
      <div class="bg-white rounded-xl shadow-md p-4 border-l-4 border-gray-800 hover:shadow-lg transition-shadow">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs text-gray-500 mb-1">Occupied Rooms</p>
            <p class="text-2xl font-bold text-gray-800">
              <span *ngIf="!isLoadingStats">{{ occupiedRooms }}</span>
              <span *ngIf="isLoadingStats" class="inline-block w-6 h-6 border-2 border-gray-800 border-t-transparent rounded-full animate-spin"></span>
            </p>
          </div>
          <div class="text-3xl">üõèÔ∏è</div>
        </div>
      </div>
    </div>

    <!-- Student Info Cards -->
    <div *ngIf="currentUser?.role === 'student'" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
      <!-- Student Room & Building Info -->
      <div class="bg-white rounded-xl shadow-md p-4 border border-gray-100">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-3">
            <div class="bg-blue-100 rounded-lg p-3">
              <span class="text-2xl">üè¢</span>
            </div>
            <div class="flex-1">
              <p class="text-xs text-gray-500 mb-1">Housing Information</p>
              <p *ngIf="isLoadingRoomInfo" class="text-sm font-semibold text-gray-400">Loading...</p>
              <div *ngIf="!isLoadingRoomInfo && studentRoomInfo" class="space-y-1">
                <p class="text-sm font-bold text-gray-800">
                  <span class="text-gray-600">Room:</span> {{ studentRoomInfo.roomNumber }}
                </p>
                <p *ngIf="studentRoomInfo.buildingName" class="text-sm font-bold text-gray-800">
                  <span class="text-gray-600">Building:</span> {{ studentRoomInfo.buildingName }}
                </p>
                <p *ngIf="studentRoomInfo.floor" class="text-sm font-bold text-gray-800">
                  <span class="text-gray-600">Floor:</span> {{ studentRoomInfo.floor }}
                </p>
              </div>
              <p *ngIf="!isLoadingRoomInfo && !studentRoomInfo" class="text-sm font-semibold text-gray-500">
                Not assigned to a room
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Student Profile Info -->
      <div class="bg-white rounded-xl shadow-md p-4 border border-gray-100">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-3">
            <div class="bg-purple-100 rounded-lg p-3">
              <span class="text-2xl">üéì</span>
            </div>
            <div class="flex-1">
              <p class="text-xs text-gray-500 mb-1">Student Information</p>
              <p *ngIf="isLoadingRoomInfo" class="text-sm font-semibold text-gray-400">Loading...</p>
              <div *ngIf="!isLoadingRoomInfo && studentInfo" class="space-y-1">
                <p *ngIf="studentInfo.college" class="text-sm font-bold text-gray-800">
                  <span class="text-gray-600">College:</span> {{ studentInfo.college }}
                </p>
                <p *ngIf="studentInfo.year" class="text-sm font-bold text-gray-800">
                  <span class="text-gray-600">Year:</span> {{ studentInfo.year }}
                </p>
                <p *ngIf="studentInfo.age" class="text-sm font-bold text-gray-800">
                  <span class="text-gray-600">Age:</span> {{ studentInfo.age }}
                </p>
                <p *ngIf="studentInfo.phoneNumber" class="text-sm font-bold text-gray-800">
                  <span class="text-gray-600">Phone:</span> {{ studentInfo.phoneNumber }}
                </p>
              </div>
              <p *ngIf="!isLoadingRoomInfo && !studentInfo" class="text-sm font-semibold text-gray-500">
                No information available
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Check-in/out Status -->
      <div class="bg-white rounded-xl shadow-md p-4 border border-gray-100">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="bg-green-100 rounded-lg p-3">
              <span class="text-2xl">üè†</span>
            </div>
            <div>
              <p class="text-xs text-gray-500 mb-1">Check In/Out Status</p>
              <p *ngIf="isLoadingStatus" class="text-sm font-semibold text-gray-400">Loading...</p>
              <div *ngIf="!isLoadingStatus" class="flex items-center gap-2">
                <span [class]="checkInOutStatus?.isCheckedIn ? 'w-2 h-2 bg-green-500 rounded-full' : 'w-2 h-2 bg-red-500 rounded-full'"></span>
                <span class="text-base font-bold text-gray-800">
                  {{ checkInOutStatus?.isCheckedIn ? 'Checked In' : 'Checked Out' }}
                </span>
              </div>
            </div>
          </div>
        </div>
        <div *ngIf="checkInOutStatus && checkInOutStatus.checkInTime" class="mt-3 pt-3 border-t border-gray-100">
          <p class="text-xs text-gray-500 mb-1">Last Check-in</p>
          <p class="text-sm font-semibold text-gray-700">{{ formatDateTime(checkInOutStatus.checkInTime) }}</p>
        </div>
      </div>

      <!-- Kitchen Status -->
      <div class="bg-white rounded-xl shadow-md p-4 border border-gray-100">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-3">
            <div class="bg-orange-100 rounded-lg p-3">
              <span class="text-2xl">üçΩÔ∏è</span>
            </div>
            <div>
              <p class="text-xs text-gray-500 mb-1">Kitchen Status</p>
              <span *ngIf="isLoadingKitchen" class="text-sm font-semibold text-gray-400">Loading...</span>
              <span *ngIf="!isLoadingKitchen && kitchenStatus?.isOpen" 
                    class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700">
                <span class="w-1.5 h-1.5 bg-green-500 rounded-full mr-1.5"></span>
                Open
              </span>
              <span *ngIf="!isLoadingKitchen && !kitchenStatus?.isOpen" 
                    class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-700">
                <span class="w-1.5 h-1.5 bg-red-500 rounded-full mr-1.5"></span>
                Closed
              </span>
            </div>
          </div>
        </div>
        
        <!-- Current Meal Info -->
        <ng-container *ngIf="!isLoadingKitchen && kitchenStatus?.isOpen && kitchenStatus?.currentMeal as currentMeal">
          <div class="mb-3 p-3 bg-green-50 rounded-lg border border-green-200">
            <p class="text-xs text-gray-600 mb-1">Current Meal</p>
            <p class="text-sm font-bold text-gray-900 mb-1">
              {{ mealNames[currentMeal.name] || currentMeal.name }}
            </p>
            <p class="text-xs text-gray-600">
              From {{ formatTime12Hour(currentMeal.startTime) }} to {{ formatTime12Hour(currentMeal.endTime) }}
            </p>
          </div>
        </ng-container>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
          <!-- Countdown Timer -->
          <div *ngIf="currentUser?.role === 'student' && (countdownTimer || isLoadingKitchen)" class="bg-gradient-to-r from-gray-700 to-gray-800 rounded-lg p-2.5 text-white border border-gray-600">
            <!-- Show closing message when timer is 0:0:0 and kitchen is open -->
            <div *ngIf="kitchenStatus?.isOpen && countdownTimer && countdownTimer.hours === 0 && countdownTimer.minutes === 0 && countdownTimer.seconds === 0" 
                 class="text-center mb-2">
              <p class="text-sm font-bold">‚è∞</p>
              <p class="text-xs font-semibold">Kitchen is closing now</p>
            </div>
            
            <p class="text-xs font-semibold mb-1.5 text-center"
               *ngIf="!(kitchenStatus?.isOpen && countdownTimer && countdownTimer.hours === 0 && countdownTimer.minutes === 0 && countdownTimer.seconds === 0)">
              <span *ngIf="kitchenStatus?.isOpen">Countdown to kitchen closing</span>
              <span *ngIf="!kitchenStatus?.isOpen">Countdown to next meal</span>
            </p>
            <div *ngIf="isLoadingKitchen" class="text-center py-2">
              <p class="text-xs opacity-90">Loading...</p>
            </div>
            <div *ngIf="!isLoadingKitchen && countdownTimer" class="flex items-center justify-center gap-1.5" style="direction: ltr;">
              <div class="text-center">
                <p class="text-base font-bold">{{ padNumber(countdownTimer.hours) }}</p>
                <p class="text-xs opacity-90">Hour</p>
              </div>
              <span class="text-base font-bold">:</span>
              <div class="text-center">
                <p class="text-base font-bold">{{ padNumber(countdownTimer.minutes) }}</p>
                <p class="text-xs opacity-90">Min</p>
              </div>
              <span class="text-base font-bold">:</span>
              <div class="text-center">
                <p class="text-base font-bold">{{ padNumber(countdownTimer.seconds) }}</p>
                <p class="text-xs opacity-90">Sec</p>
              </div>
            </div>
            <div *ngIf="!isLoadingKitchen && !countdownTimer" class="text-center py-2">
              <p class="text-xs opacity-90">No upcoming meal</p>
            </div>
          </div>
          <div *ngIf="nextMealTime" class="bg-gray-50 rounded-lg p-2">
            <p class="text-xs text-gray-500 mb-1">
              <span *ngIf="kitchenStatus?.isOpen">Kitchen closing time</span>
              <ng-container *ngIf="!kitchenStatus?.isOpen && kitchenStatus?.nextMeal as nextMeal">
                <span>Next meal: {{ mealNames[nextMeal.name] }}</span>
              </ng-container>
            </p>
            <p class="text-sm font-bold text-gray-800">{{ nextMealTime }}</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chat Widget for Students -->
<app-chat-widget *ngIf="currentUser?.role === 'student'"></app-chat-widget>
</app-layout>

