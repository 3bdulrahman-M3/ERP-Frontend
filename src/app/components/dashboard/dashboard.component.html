<app-layout [pageTitle]="currentPageTitle || languageService.translate('dashboard.title')">
<div *ngIf="currentRoute === '/dashboard'" class="p-4">
  <div class="space-y-4">
    <!-- Welcome Header -->
    <div class="relative overflow-hidden bg-gradient-to-r from-gray-800 via-gray-700 to-gray-800 rounded-2xl shadow-xl p-6 text-white border border-gray-600">
      <div class="relative z-10">
        <div class="flex items-center justify-between flex-wrap gap-4">
          <div>
            <h1 class="text-3xl font-bold mb-2 flex items-center gap-2">
              {{ languageService.translate('dashboard.welcome') }} {{ currentUser?.name }}
              <img src="/assets/images/3d269b3beb668c449f56e10b64790f5fe9279f15 (1).gif" alt="Welcome" class="w-10 h-10 inline-block transform scale-x-[-1]" />
            </h1>
            <p class="text-white/90 text-sm">
              {{ currentUser?.role === 'admin' ? languageService.translate('dashboard.adminDashboard') : languageService.translate('dashboard.studentDashboard') }}
            </p>
          </div>
          <div class="flex items-center gap-3">
            <div class="bg-white/10 backdrop-blur-sm rounded-xl px-4 py-2 border border-white/20">
              <span class="text-lg font-bold text-white">
                {{ currentUser?.role === 'admin' ? 'üëë' : 'üéì' }}
              </span>
              <span class="ml-2 font-semibold">{{ currentUser?.role === 'admin' ? languageService.translate('common.admin') : languageService.translate('common.student') }}</span>
            </div>
          </div>
        </div>
      </div>
      <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
      <div class="absolute bottom-0 left-0 w-24 h-24 bg-white/10 rounded-full blur-2xl"></div>
    </div>
    
    <!-- User Info - Compact -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
      <div class="bg-white rounded-xl shadow-md p-4 border border-gray-100">
        <p class="text-xs text-gray-500 mb-1">{{ languageService.translate('common.name') }}</p>
        <p class="text-base font-semibold text-gray-800">{{ currentUser?.name }}</p>
      </div>
      <div class="bg-white rounded-xl shadow-md p-4 border border-gray-100">
        <p class="text-xs text-gray-500 mb-1">{{ languageService.translate('common.email') }}</p>
        <p class="text-sm font-semibold text-gray-800 truncate">{{ currentUser?.email }}</p>
      </div>
    </div>

    <!-- Quick Stats - Admin Only -->
    <div *ngIf="currentUser?.role === 'admin'" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
      <!-- Total Students -->
      <div class="bg-white/90 backdrop-blur-sm rounded-xl shadow-lg p-6 border-l-4 border-blue-500 hover:shadow-xl transition-all transform hover:scale-105">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs text-gray-600 mb-2 font-medium">{{ languageService.translate('dashboard.totalStudents') }}</p>
            <p class="text-3xl font-bold text-gray-800">
              <span *ngIf="!isLoadingStats">{{ totalStudents }}</span>
              <span *ngIf="isLoadingStats" class="inline-block w-6 h-6 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></span>
            </p>
          </div>
          <div class="bg-blue-100 rounded-full p-3">
            <span class="material-icons text-blue-600 text-3xl">school</span>
          </div>
        </div>
      </div>

      <!-- Total Rooms -->
      <div class="bg-white/90 backdrop-blur-sm rounded-xl shadow-lg p-6 border-l-4 border-green-500 hover:shadow-xl transition-all transform hover:scale-105">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs text-gray-600 mb-2 font-medium">{{ languageService.translate('dashboard.totalRooms') }}</p>
            <p class="text-3xl font-bold text-gray-800">
              <span *ngIf="!isLoadingStats">{{ totalRooms }}</span>
              <span *ngIf="isLoadingStats" class="inline-block w-6 h-6 border-2 border-green-500 border-t-transparent rounded-full animate-spin"></span>
            </p>
          </div>
          <div class="bg-green-100 rounded-full p-3">
            <span class="material-icons text-green-600 text-3xl">meeting_room</span>
          </div>
        </div>
      </div>

      <!-- Total Buildings -->
      <div class="bg-white/90 backdrop-blur-sm rounded-xl shadow-lg p-6 border-l-4 border-purple-500 hover:shadow-xl transition-all transform hover:scale-105">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs text-gray-600 mb-2 font-medium">{{ languageService.translate('dashboard.totalBuildings') }}</p>
            <p class="text-3xl font-bold text-gray-800">
              <span *ngIf="!isLoadingStats">{{ totalBuildings }}</span>
              <span *ngIf="isLoadingStats" class="inline-block w-6 h-6 border-2 border-purple-500 border-t-transparent rounded-full animate-spin"></span>
            </p>
          </div>
          <div class="bg-purple-100 rounded-full p-3">
            <span class="material-icons text-purple-600 text-3xl">business</span>
          </div>
        </div>
      </div>

      <!-- Available Rooms -->
      <div class="bg-white/90 backdrop-blur-sm rounded-xl shadow-lg p-6 border-l-4 border-teal-500 hover:shadow-xl transition-all transform hover:scale-105">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs text-gray-600 mb-2 font-medium">{{ languageService.translate('dashboard.availableRooms') }}</p>
            <p class="text-3xl font-bold text-gray-800">
              <span *ngIf="!isLoadingStats">{{ availableRooms }}</span>
              <span *ngIf="isLoadingStats" class="inline-block w-6 h-6 border-2 border-teal-500 border-t-transparent rounded-full animate-spin"></span>
            </p>
          </div>
          <div class="bg-teal-100 rounded-full p-3">
            <span class="material-icons text-teal-600 text-3xl">check_circle</span>
          </div>
        </div>
      </div>

      <!-- Occupied Rooms -->
      <div class="bg-white/90 backdrop-blur-sm rounded-xl shadow-lg p-6 border-l-4 border-orange-500 hover:shadow-xl transition-all transform hover:scale-105">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs text-gray-600 mb-2 font-medium">{{ languageService.translate('dashboard.occupiedRooms') }}</p>
            <p class="text-3xl font-bold text-gray-800">
              <span *ngIf="!isLoadingStats">{{ occupiedRooms }}</span>
              <span *ngIf="isLoadingStats" class="inline-block w-6 h-6 border-2 border-orange-500 border-t-transparent rounded-full animate-spin"></span>
            </p>
          </div>
          <div class="bg-orange-100 rounded-full p-3">
            <span class="material-icons text-orange-600 text-3xl">bed</span>
          </div>
        </div>
      </div>

      <!-- Students Checked In -->
      <div class="bg-white/90 backdrop-blur-sm rounded-xl shadow-lg p-6 border-l-4 border-indigo-500 hover:shadow-xl transition-all transform hover:scale-105">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs text-gray-600 mb-2 font-medium">{{ languageService.translate('dashboard.studentsCheckedIn') }}</p>
            <p class="text-3xl font-bold text-gray-800">
              <span *ngIf="!isLoadingStats">{{ studentsCheckedIn }}</span>
              <span *ngIf="isLoadingStats" class="inline-block w-6 h-6 border-2 border-indigo-500 border-t-transparent rounded-full animate-spin"></span>
            </p>
          </div>
          <div class="bg-indigo-100 rounded-full p-3">
            <span class="material-icons text-indigo-600 text-3xl">login</span>
          </div>
        </div>
      </div>

      <!-- Students Checked Out -->
      <div class="bg-white/90 backdrop-blur-sm rounded-xl shadow-lg p-6 border-l-4 border-red-500 hover:shadow-xl transition-all transform hover:scale-105">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs text-gray-600 mb-2 font-medium">{{ languageService.translate('dashboard.studentsCheckedOut') }}</p>
            <p class="text-3xl font-bold text-gray-800">
              <span *ngIf="!isLoadingStats">{{ studentsCheckedOut }}</span>
              <span *ngIf="isLoadingStats" class="inline-block w-6 h-6 border-2 border-red-500 border-t-transparent rounded-full animate-spin"></span>
            </p>
          </div>
          <div class="bg-red-100 rounded-full p-3">
            <span class="material-icons text-red-600 text-3xl">logout</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts Section - Admin Only -->
    <div *ngIf="currentUser?.role === 'admin' && !isLoadingStats" class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
      <!-- Rooms Chart -->
      <div class="bg-white/95 backdrop-blur-md rounded-2xl shadow-xl p-6 border border-gray-100 hover:shadow-2xl transition-all duration-300">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-xl font-bold text-gray-800 flex items-center gap-3">
            <div class="bg-gradient-to-br from-green-500 to-emerald-600 rounded-lg p-2 shadow-lg">
              <span class="material-icons text-white text-2xl">pie_chart</span>
            </div>
            <span>{{ languageService.translate('dashboard.roomsDistribution') }}</span>
          </h3>
          <div class="flex items-center gap-2 text-sm text-gray-600">
            <span class="material-icons text-xs">info</span>
            <span>{{ languageService.translate('dashboard.total') }}: {{ totalRooms }}</span>
          </div>
        </div>
        <div class="h-80 relative">
          <canvas id="roomsChart" *ngIf="!isLoadingStats"></canvas>
          <div *ngIf="isLoadingStats" class="flex items-center justify-center h-full">
            <div class="text-center">
              <div class="inline-block w-8 h-8 border-4 border-green-500 border-t-transparent rounded-full animate-spin mb-2"></div>
              <p class="text-sm text-gray-500">{{ languageService.translate('dashboard.loading') }}</p>
            </div>
          </div>
        </div>
        <div class="mt-4 grid grid-cols-2 gap-4 pt-4 border-t border-gray-100">
          <div class="flex items-center gap-2">
            <div class="w-3 h-3 rounded-full bg-green-500"></div>
            <span class="text-sm text-gray-600">{{ languageService.translate('dashboard.available') }}: <span class="font-bold text-gray-800">{{ availableRooms }}</span></span>
          </div>
          <div class="flex items-center gap-2">
            <div class="w-3 h-3 rounded-full bg-red-500"></div>
            <span class="text-sm text-gray-600">{{ languageService.translate('dashboard.occupied') }}: <span class="font-bold text-gray-800">{{ occupiedRooms }}</span></span>
          </div>
        </div>
      </div>

      <!-- Students Check-in/out Chart -->
      <div class="bg-white/95 backdrop-blur-md rounded-2xl shadow-xl p-6 border border-gray-100 hover:shadow-2xl transition-all duration-300">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-xl font-bold text-gray-800 flex items-center gap-3">
            <div class="bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg p-2 shadow-lg">
              <span class="material-icons text-white text-2xl">bar_chart</span>
            </div>
            <span>{{ languageService.translate('dashboard.studentsStatusToday') }}</span>
          </h3>
          <div class="flex items-center gap-2 text-sm text-gray-600">
            <span class="material-icons text-xs">today</span>
            <span>{{ getCurrentDate() }}</span>
          </div>
        </div>
        <div class="h-80 relative">
          <canvas id="studentsChart" *ngIf="!isLoadingStats"></canvas>
          <div *ngIf="isLoadingStats" class="flex items-center justify-center h-full">
            <div class="text-center">
              <div class="inline-block w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-2"></div>
              <p class="text-sm text-gray-500">{{ languageService.translate('dashboard.loading') }}</p>
            </div>
          </div>
        </div>
        <div class="mt-4 grid grid-cols-2 gap-4 pt-4 border-t border-gray-100">
          <div class="flex items-center gap-2">
            <div class="w-3 h-3 rounded-full bg-blue-500"></div>
            <span class="text-sm text-gray-600">{{ languageService.translate('dashboard.inside') }}: <span class="font-bold text-gray-800">{{ studentsCheckedIn }}</span></span>
          </div>
          <div class="flex items-center gap-2">
            <div class="w-3 h-3 rounded-full bg-amber-500"></div>
            <span class="text-sm text-gray-600">{{ languageService.translate('dashboard.outside') }}: <span class="font-bold text-gray-800">{{ studentsCheckedOut }}</span></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Student Info Cards -->
    <div *ngIf="currentUser?.role === 'student'" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
      <!-- Student Room & Building Info -->
      <div class="bg-white rounded-xl shadow-md p-4 border border-gray-100">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-3">
            <div class="bg-blue-100 rounded-lg p-3">
              <span class="text-2xl">üè¢</span>
            </div>
            <div class="flex-1">
              <p class="text-xs text-gray-500 mb-1">{{ languageService.translate('dashboard.housingInfo') }}</p>
              <p *ngIf="isLoadingRoomInfo" class="text-sm font-semibold text-gray-400">{{ languageService.translate('common.loading') }}</p>
              <div *ngIf="!isLoadingRoomInfo && studentRoomInfo" class="space-y-1">
                <p class="text-sm font-bold text-gray-800">
                  <span class="text-gray-600">{{ languageService.translate('dashboard.roomNumber') }}:</span> {{ studentRoomInfo.roomNumber }}
                </p>
                <p *ngIf="studentRoomInfo.buildingName" class="text-sm font-bold text-gray-800">
                  <span class="text-gray-600">{{ languageService.translate('dashboard.building') }}:</span> {{ studentRoomInfo.buildingName }}
                </p>
                <p *ngIf="studentRoomInfo.floor" class="text-sm font-bold text-gray-800">
                  <span class="text-gray-600">{{ languageService.translate('dashboard.floor') }}:</span> {{ studentRoomInfo.floor }}
                </p>
              </div>
              <p *ngIf="!isLoadingRoomInfo && !studentRoomInfo" class="text-sm font-semibold text-gray-500">
                {{ languageService.translate('dashboard.notAssigned') }}
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Student Profile Info -->
      <div class="bg-white rounded-xl shadow-md p-4 border border-gray-100">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-3">
            <div class="bg-purple-100 rounded-lg p-3">
              <span class="text-2xl">üéì</span>
            </div>
            <div class="flex-1">
              <p class="text-xs text-gray-500 mb-1">{{ languageService.translate('dashboard.studentInfo') }}</p>
              <p *ngIf="isLoadingRoomInfo" class="text-sm font-semibold text-gray-400">{{ languageService.translate('common.loading') }}</p>
              <div *ngIf="!isLoadingRoomInfo && studentInfo" class="space-y-1">
                <p *ngIf="studentInfo.college" class="text-sm font-bold text-gray-800">
                  <span class="text-gray-600">{{ languageService.translate('dashboard.college') }}:</span> {{ studentInfo.college }}
                </p>
                <p *ngIf="studentInfo.year" class="text-sm font-bold text-gray-800">
                  <span class="text-gray-600">{{ languageService.translate('dashboard.year') }}:</span> {{ studentInfo.year }}
                </p>
                <p *ngIf="studentInfo.age" class="text-sm font-bold text-gray-800">
                  <span class="text-gray-600">{{ languageService.translate('dashboard.age') }}:</span> {{ studentInfo.age }}
                </p>
                <p *ngIf="studentInfo.phoneNumber" class="text-sm font-bold text-gray-800">
                  <span class="text-gray-600">{{ languageService.translate('dashboard.phoneNumber') }}:</span> {{ studentInfo.phoneNumber }}
                </p>
              </div>
              <p *ngIf="!isLoadingRoomInfo && !studentInfo" class="text-sm font-semibold text-gray-500">
                {{ languageService.translate('dashboard.noInfo') }}
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Check-in/out Status -->
      <div class="bg-white rounded-xl shadow-md p-4 border border-gray-100">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="bg-green-100 rounded-lg p-3">
              <span class="text-2xl">üè†</span>
            </div>
            <div>
              <p class="text-xs text-gray-500 mb-1">{{ languageService.translate('dashboard.checkInStatus') }}</p>
              <p *ngIf="isLoadingStatus" class="text-sm font-semibold text-gray-400">{{ languageService.translate('common.loading') }}</p>
              <div *ngIf="!isLoadingStatus" class="flex items-center gap-2">
                <span [class]="checkInOutStatus?.isCheckedIn ? 'w-2 h-2 bg-green-500 rounded-full' : 'w-2 h-2 bg-red-500 rounded-full'"></span>
                <span class="text-base font-bold text-gray-800">
                  {{ checkInOutStatus?.isCheckedIn ? languageService.translate('dashboard.checkedIn') : languageService.translate('dashboard.checkedOut') }}
                </span>
              </div>
            </div>
          </div>
        </div>
        <div *ngIf="checkInOutStatus && checkInOutStatus.checkInTime" class="mt-3 pt-3 border-t border-gray-100">
          <p class="text-xs text-gray-500 mb-1">{{ languageService.translate('dashboard.checkInTime') }}</p>
          <p class="text-sm font-semibold text-gray-700">{{ formatDateTime(checkInOutStatus.checkInTime) }}</p>
        </div>
      </div>

      <!-- Kitchen Status -->
      <div class="bg-white rounded-xl shadow-md p-4 border border-gray-100">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-3">
            <div class="bg-orange-100 rounded-lg p-3">
              <span class="text-2xl">üçΩÔ∏è</span>
            </div>
            <div>
              <p class="text-xs text-gray-500 mb-1">{{ languageService.translate('dashboard.kitchenStatus') }}</p>
              <span *ngIf="isLoadingKitchen" class="text-sm font-semibold text-gray-400">{{ languageService.translate('common.loading') }}</span>
              <span *ngIf="!isLoadingKitchen && kitchenStatus?.isOpen" 
                    class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700">
                <span class="w-1.5 h-1.5 bg-green-500 rounded-full mr-1.5"></span>
                {{ languageService.translate('dashboard.open') }}
              </span>
              <span *ngIf="!isLoadingKitchen && !kitchenStatus?.isOpen" 
                    class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-700">
                <span class="w-1.5 h-1.5 bg-red-500 rounded-full mr-1.5"></span>
                {{ languageService.translate('dashboard.closed') }}
              </span>
            </div>
          </div>
        </div>
        
        <!-- Current Meal Info -->
        <ng-container *ngIf="!isLoadingKitchen && kitchenStatus?.isOpen && kitchenStatus?.currentMeal as currentMeal">
          <div class="mb-3 p-3 bg-green-50 rounded-lg border border-green-200">
            <p class="text-xs text-gray-600 mb-1">{{ languageService.translate('dashboard.currentMeal') }}</p>
            <p class="text-sm font-bold text-gray-900 mb-1">
              {{ mealNames[currentMeal.name] || currentMeal.name }}
            </p>
            <p class="text-xs text-gray-600">
              {{ languageService.translate('dashboard.from') }} {{ formatTime12Hour(currentMeal.startTime) }} {{ languageService.translate('dashboard.to') }} {{ formatTime12Hour(currentMeal.endTime) }}
            </p>
          </div>
        </ng-container>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
          <!-- Countdown Timer -->
          <div *ngIf="currentUser?.role === 'student' && (countdownTimer || isLoadingKitchen)" class="bg-gradient-to-r from-gray-700 to-gray-800 rounded-lg p-2.5 text-white border border-gray-600">
            <!-- Show closing message when timer is 0:0:0 and kitchen is open -->
            <div *ngIf="kitchenStatus?.isOpen && countdownTimer && countdownTimer.hours === 0 && countdownTimer.minutes === 0 && countdownTimer.seconds === 0" 
                 class="text-center mb-2">
              <p class="text-sm font-bold">‚è∞</p>
              <p class="text-xs font-semibold">{{ languageService.translate('dashboard.kitchenClosing') }}</p>
            </div>
            
            <p class="text-xs font-semibold mb-1.5 text-center"
               *ngIf="!(kitchenStatus?.isOpen && countdownTimer && countdownTimer.hours === 0 && countdownTimer.minutes === 0 && countdownTimer.seconds === 0)">
              <span *ngIf="kitchenStatus?.isOpen">{{ languageService.translate('dashboard.countdownClosing') }}</span>
              <span *ngIf="!kitchenStatus?.isOpen">{{ languageService.translate('dashboard.countdownNext') }}</span>
            </p>
            <div *ngIf="isLoadingKitchen" class="text-center py-2">
              <p class="text-xs opacity-90">{{ languageService.translate('common.loading') }}</p>
            </div>
            <div *ngIf="!isLoadingKitchen && countdownTimer" class="flex items-center justify-center gap-1.5" style="direction: ltr;">
              <div class="text-center">
                <p class="text-base font-bold">{{ padNumber(countdownTimer.hours) }}</p>
                <p class="text-xs opacity-90">{{ languageService.translate('dashboard.hour') }}</p>
              </div>
              <span class="text-base font-bold">:</span>
              <div class="text-center">
                <p class="text-base font-bold">{{ padNumber(countdownTimer.minutes) }}</p>
                <p class="text-xs opacity-90">{{ languageService.translate('dashboard.min') }}</p>
              </div>
              <span class="text-base font-bold">:</span>
              <div class="text-center">
                <p class="text-base font-bold">{{ padNumber(countdownTimer.seconds) }}</p>
                <p class="text-xs opacity-90">{{ languageService.translate('dashboard.sec') }}</p>
              </div>
            </div>
            <div *ngIf="!isLoadingKitchen && !countdownTimer" class="text-center py-2">
              <p class="text-xs opacity-90">{{ languageService.translate('dashboard.noUpcoming') }}</p>
            </div>
          </div>
          <div *ngIf="nextMealTime" class="bg-gray-50 rounded-lg p-2">
            <p class="text-xs text-gray-500 mb-1">
              <span *ngIf="kitchenStatus?.isOpen">{{ languageService.translate('dashboard.closingTime') }}</span>
              <ng-container *ngIf="!kitchenStatus?.isOpen && kitchenStatus?.nextMeal as nextMeal">
                <span>{{ languageService.translate('dashboard.nextMeal') }}: {{ mealNames[nextMeal.name] }}</span>
              </ng-container>
            </p>
            <p class="text-sm font-bold text-gray-800">{{ nextMealTime }}</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chat Widget for Students -->
<app-chat-widget *ngIf="currentUser?.role === 'student'"></app-chat-widget>
</app-layout>

