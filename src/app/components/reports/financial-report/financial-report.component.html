<app-layout pageTitle="Financial Report">
  <div class="p-6 space-y-6 animate-fade-in">
    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      <div class="summary-card bg-gradient-to-br from-gray-700 to-gray-800 text-white">
        <p class="text-sm opacity-80">Total Due</p>
        <p class="text-3xl font-bold mt-2">{{ formatCurrency(totals.totalDue) }}</p>
      </div>
      <div class="summary-card bg-gradient-to-br from-gray-600 to-gray-700 text-white">
        <p class="text-sm opacity-80">Total Paid</p>
        <p class="text-3xl font-bold mt-2">{{ formatCurrency(totals.totalPaid) }}</p>
      </div>
      <div class="summary-card bg-gradient-to-br from-gray-800 to-gray-900 text-white">
        <p class="text-sm opacity-80">Total Remaining</p>
        <p class="text-3xl font-bold mt-2">{{ formatCurrency(totals.totalRemaining) }}</p>
      </div>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-2xl shadow p-6">
      <h3 class="text-xl font-bold text-gray-800 mb-4">Filters</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">From Date</label>
          <input type="date" [(ngModel)]="filters.startDate" name="startDate" class="filter-input" />
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">To Date</label>
          <input type="date" [(ngModel)]="filters.endDate" name="endDate" class="filter-input" />
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Payment Method</label>
          <select [(ngModel)]="filters.paymentMethod" name="paymentMethod" class="filter-input">
            <option value="">All</option>
            <option *ngFor="let method of paymentMethodOptions" [value]="method.value">{{ method.label }}</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Payment Status</label>
          <select [(ngModel)]="filters.status" name="status" class="filter-input">
            <option value="">All</option>
            <option value="paid">Paid</option>
            <option value="partial">Partially Paid</option>
            <option value="unpaid">Unpaid</option>
          </select>
        </div>
      </div>
      <div class="flex flex-col md:flex-row gap-3 mt-4">
        <button (click)="loadReport()" class="btn-primary flex-1 px-4 py-3 text-white rounded-xl font-bold text-center">
          Apply Filters
        </button>
        <button (click)="resetFilters()" class="flex-1 px-4 py-3 border border-gray-300 rounded-xl font-bold text-gray-700 hover:bg-gray-50">
          Reset
        </button>
      </div>
    </div>

    <!-- Error Message -->
    <div *ngIf="errorMessage" class="bg-gray-50 border border-gray-300 text-gray-700 px-4 py-3 rounded">
      {{ errorMessage }}
    </div>

    <!-- Payments Table -->
    <div class="bg-white rounded-2xl shadow overflow-hidden">
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="table-head">Student</th>
              <th class="table-head">Room</th>
              <th class="table-head">Payment Status</th>
              <th class="table-head">Payment Method</th>
              <th class="table-head">Amount Due</th>
              <th class="table-head">Amount Paid</th>
              <th class="table-head">Remaining</th>
              <th class="table-head">Payment Date</th>
              <th class="table-head">Actions</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <tr *ngIf="isLoading">
              <td colspan="9" class="text-center py-6 text-gray-500">Loading...</td>
            </tr>
            <tr *ngIf="!isLoading && payments.length === 0">
              <td colspan="9" class="text-center py-6 text-gray-500">No data available</td>
            </tr>
            <tr *ngFor="let payment of payments" class="hover:bg-gray-50">
              <td class="table-cell">
                <div class="font-semibold text-gray-900">{{ payment.student?.name || 'Unknown' }}</div>
                <div class="text-xs text-gray-500">{{ payment.student?.email }}</div>
              </td>
              <td class="table-cell">{{ payment.room?.roomNumber || '-' }}</td>
              <td class="table-cell">
                <span class="px-3 py-1 rounded-full text-xs font-semibold" [ngClass]="getStatusClass(payment.status)">
                  {{ getStatusLabel(payment.status) }}
                </span>
              </td>
              <td class="table-cell">{{ getMethodLabel(payment.paymentMethod) }}</td>
              <td class="table-cell font-semibold text-gray-900">{{ formatCurrency(payment.amountDue) }}</td>
              <td class="table-cell font-semibold text-gray-700">{{ formatCurrency(payment.amountPaid) }}</td>
              <td class="table-cell font-semibold text-gray-800">{{ formatCurrency(payment.remainingAmount) }}</td>
              <td class="table-cell text-sm text-gray-600">{{ payment.paymentDate | date: 'yyyy-MM-dd HH:mm' }}</td>
              <td class="table-cell">
                <button
                  *ngIf="payment.status === 'unpaid' && payment.id"
                  (click)="openAddPaymentModal(payment)"
                  class="p-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition duration-200"
                  title="Add Payment"
                >
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                  </svg>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Add Payment Modal -->
    <div
      *ngIf="showAddPaymentModal"
      class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 animate-fade-in"
      (click)="closeAddPaymentModal()"
    >
      <div
        class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 animate-scale-in"
        (click)="$event.stopPropagation()"
      >
        <h3 class="text-2xl font-bold text-gray-800 mb-6">Add Payment</h3>
        
        <div class="mb-4 p-4 bg-gray-50 rounded-lg">
          <p class="text-sm text-gray-600 mb-1">Student: <span class="font-semibold text-gray-900">{{ selectedPayment?.student?.name || 'Unknown' }}</span></p>
          <p class="text-sm text-gray-600 mb-1">Amount Due: <span class="font-semibold text-gray-900">{{ formatCurrency(selectedPayment?.amountDue) }}</span></p>
          <p class="text-sm text-gray-600">Remaining: <span class="font-semibold text-gray-900">{{ formatCurrency(selectedPayment?.remainingAmount) }}</span></p>
        </div>
        
        <div class="mb-6">
          <label class="block text-sm font-bold text-gray-700 mb-2">Payment Amount ($)</label>
          <input
            type="number"
            [(ngModel)]="additionalPaymentAmount"
            min="0.01"
            step="0.01"
            [max]="selectedPayment?.remainingAmount || 0"
            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
            placeholder="Enter amount"
          />
        </div>

        <div class="mb-6">
          <label class="block text-sm font-bold text-gray-700 mb-2">Payment Method</label>
          <select
            [(ngModel)]="additionalPaymentMethod"
            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
          >
            <option *ngFor="let method of paymentMethodOptions" [value]="method.value">
              {{ method.label }}
            </option>
          </select>
        </div>

        <div class="mb-6">
          <label class="block text-sm font-bold text-gray-700 mb-2">Notes (optional)</label>
          <textarea
            [(ngModel)]="additionalPaymentNotes"
            rows="3"
            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
            placeholder="Add notes about this payment..."
          ></textarea>
        </div>

        <div class="flex gap-3">
          <button
            (click)="closeAddPaymentModal()"
            class="flex-1 px-4 py-3 border border-gray-300 rounded-xl text-gray-700 font-bold hover:bg-gray-50 transition duration-200"
          >
            Cancel
          </button>
          <button
            (click)="addPayment()"
            [disabled]="!additionalPaymentAmount || additionalPaymentAmount <= 0 || isAddingPayment"
            class="btn-primary flex-1 px-4 py-3 text-white rounded-xl font-bold transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <span *ngIf="!isAddingPayment">Add Payment</span>
            <span *ngIf="isAddingPayment">Adding...</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</app-layout>

