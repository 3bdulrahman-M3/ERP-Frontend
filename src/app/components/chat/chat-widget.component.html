<!-- Chat Widget - Minimized State -->
<div *ngIf="isMinimized" class="fixed bottom-4 left-4 z-50">
  <button
    (click)="toggleMinimize()"
    class="bg-blue-600 text-white px-6 py-3 rounded-full shadow-lg hover:bg-blue-700 transition-colors flex items-center gap-2"
  >
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
    </svg>
    <span>المحادثة</span>
    <span *ngIf="unreadCount > 0" class="bg-red-500 text-white text-xs rounded-full px-2 py-0.5">
      {{ unreadCount }}
    </span>
  </button>
</div>

<!-- Chat Widget - Expanded State -->
<div *ngIf="!isMinimized" class="fixed bottom-4 left-4 z-50 w-96 h-[500px] bg-white rounded-lg shadow-2xl border border-gray-200 flex flex-col" style="direction: rtl;">
  <!-- Header -->
  <div class="p-4 border-b border-gray-200 bg-blue-600 text-white rounded-t-lg flex items-center justify-between">
    <div>
      <h3 class="font-semibold">المحادثة مع الإدارة</h3>
      <p *ngIf="unreadCount > 0" class="text-xs text-blue-100 mt-1">
        {{ unreadCount }} رسالة غير مقروءة
      </p>
    </div>
    <button
      (click)="toggleMinimize()"
      class="text-white hover:text-blue-200 transition-colors"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
      </svg>
    </button>
  </div>

  <!-- Messages Container -->
  <div
    #messagesContainer
    id="messagesContainer"
    class="flex-1 overflow-y-auto p-4 space-y-3 space-y-reverse bg-gray-50 min-h-0"
    style="direction: rtl;"
  >
    <div *ngIf="!conversation" class="text-center text-gray-500 py-8">
      <p>جاري تحميل المحادثة...</p>
    </div>
    
    <div *ngIf="conversation && messages.length === 0" class="text-center text-gray-500 py-8">
      <p>لا توجد رسائل بعد</p>
      <p class="text-sm mt-2">ابدأ المحادثة مع الإدارة</p>
    </div>

    <div *ngFor="let message of messages" class="flex" [class.justify-end]="isMyMessage(message)" [class.justify-start]="!isMyMessage(message)">
      <div
        [class.bg-blue-600]="isMyMessage(message)"
        [class.text-white]="isMyMessage(message)"
        [class.bg-gray-200]="!isMyMessage(message)"
        [class.text-gray-900]="!isMyMessage(message)"
        [class.mr-auto]="!isMyMessage(message)"
        [class.ml-auto]="isMyMessage(message)"
        class="max-w-[75%] px-3 py-2 rounded-2xl shadow-sm text-sm"
      >
        <p class="whitespace-pre-wrap break-words">{{ message.content }}</p>
        <p
          [class.text-blue-100]="isMyMessage(message)"
          [class.text-gray-500]="!isMyMessage(message)"
          class="text-xs mt-1 text-left"
        >
          {{ formatTime(message.createdAt) }}
        </p>
      </div>
    </div>
  </div>

  <!-- Message Input -->
  <div class="p-3 border-t border-gray-200 bg-white rounded-b-lg">
    <form (ngSubmit)="sendMessage()" class="flex gap-2" style="direction: rtl;">
      <input
        type="text"
        [(ngModel)]="newMessage"
        name="newMessage"
        placeholder="اكتب رسالة..."
        class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-full focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
        [disabled]="isLoading || !conversation"
      />
      <button
        type="submit"
        [disabled]="!newMessage.trim() || isLoading || !conversation"
        class="px-4 py-2 bg-blue-600 text-white rounded-full text-sm font-semibold hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
      >
        <svg *ngIf="!isLoading" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
        </svg>
        <span *ngIf="isLoading" class="inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></span>
      </button>
    </form>
    <p *ngIf="!conversation" class="text-xs text-gray-500 mt-2 text-center">جاري تحميل المحادثة...</p>
  </div>
</div>

